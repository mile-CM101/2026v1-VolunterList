<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>志工排班查詢系統 2026 (Calendar V3.8 Interactive)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
    <style>
        /* 隱藏滾動條但保留功能 */
        .no-scrollbar::-webkit-scrollbar {
          display: none;
        }
        .no-scrollbar {
          -ms-overflow-style: none;  /* IE and Edge */
          scrollbar-width: none;  /* Firefox */
        }
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-down {
            animation: fadeInDown 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module" data-presets="react">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as LucideIcons from 'lucide-react';

        // ========== Icon 元件 ==========
        const Icon = ({ name, className = "", ...props }) => {
            const IconComponent = LucideIcons[name];
            if (!IconComponent) return null;
            return <IconComponent className={className} {...props} />;
        };

        const APP_VERSION = "App v3.8.0 (Interactive Info)"; 
        const DEFAULT_DATA_VERSION = "Data 2026 (Embedded)";

        // --- 輔助函式 ---
        const normalizeDate = (dateStr) => {
            if (!dateStr) return "";
            // 將 2026/2/17 轉為 2026/02/17 以便比對
            if (dateStr.match(/^\d{4}\/\d{1,2}\/\d{1,2}/)) {
                const cleanDate = dateStr.split(' ')[0];
                const parts = cleanDate.split('/');
                return `${parts[0]}/${parts[1].padStart(2, '0')}/${parts[2].padStart(2, '0')}`;
            }
            const match = dateStr.match(/(\d{1,2})\/(\d{1,2})/);
            if (match) {
                return `2026/${match[1].padStart(2, '0')}/${match[2].padStart(2, '0')}`;
            }
            return dateStr;
        };

        const ensureYearInString = (dateStr) => {
            if (!dateStr) return "";
            const str = String(dateStr).trim();
            if (!str.match(/^\d{4}/)) {
                return `2026/${str}`;
            }
            return str;
        };

        // --- 內建完整資料 (部署版專用) ---
        const EMBEDDED_DHARMA_DATA = [
            { "date": "2026/01/11", "title": "嚴聖尊佛成道日法會", "location": "新竹 冥聖九華山大地藏王佛玄皇寺" },
            { "date": "2026/01/25", "title": "嚴仁尊佛成道日法會", "location": "新竹 冥聖九華山大地藏王佛玄皇寺" },
            { "date": "2026/02/17", "title": "彌勒尊佛佛誕日法會", "location": "新竹 冥聖九華山大地藏王佛玄皇寺" },
            { "date": "2026/03/07", "title": "皇母聖道日法會", "location": "新店 陀彌天山紫竹林寺" },
            { "date": "2026/03/08", "title": "皇母聖道日法會", "location": "新店 陀彌天山紫竹林寺" },
            { "date": "2026/03/28", "title": "皇母聖誕日法會", "location": "新店 陀彌天山紫竹林寺" },
            { "date": "2026/03/29", "title": "皇母聖誕日法會", "location": "新店 陀彌天山紫竹林寺" },
            { "date": "2026/04/12", "title": "清明祈福法會", "location": "新竹 冥聖九華山大地藏王佛玄皇寺" },
            { "date": "2026/04/26", "title": "盤古尊佛成道日法會", "location": "深坑 大正金剛轉輪寺" },
            { "date": "2026/05/09", "title": "媽祖天后聖誕日法會", "location": "台南 彌勒三皇母寶殿九龍媽祖廟" },
            { "date": "2026/06/28", "title": "嚴慈尊佛成道日法會", "location": "新竹 冥聖九華山大地藏王佛玄皇寺" },
            { "date": "2026/08/01", "title": "皇母出家日法會", "location": "新店 陀彌天山紫竹林寺" },
            { "date": "2026/08/02", "title": "皇母出家日法會", "location": "新店 陀彌天山紫竹林寺" },
            { "date": "2026/08/30", "title": "中元普渡祈福法會", "location": "新竹 冥聖九華山大地藏王佛玄皇寺" },
            { "date": "2026/10/17", "title": "媽祖天后成道日法會", "location": "台南 彌勒三皇母寶殿九龍媽祖廟" },
            { "date": "2026/10/31", "title": "皇母成道日法會", "location": "新店 陀彌天山紫竹林寺" },
            { "date": "2026/11/01", "title": "皇母成道日法會", "location": "新店 陀彌天山紫竹林寺" },
            { "date": "2026/12/27", "title": "嚴聖尊佛成道日法會", "location": "新竹 冥聖九華山大地藏王佛玄皇寺" }
        ];

        // --- 法會日期彈窗 (Modal) ---
        const DharmaModal = ({ isOpen, onClose, data, isLoading, error }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm transition-all" onClick={onClose}>
                    <div 
                        className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col overflow-hidden animate-[fadeIn_0.2s_ease-out]"
                        onClick={e => e.stopPropagation()}
                    >
                        {/* Modal Header */}
                        <div className="bg-gradient-to-r from-amber-500 to-amber-600 px-6 py-4 flex justify-between items-center shrink-0">
                            <h3 className="text-xl font-bold text-white flex items-center gap-2">
                                <Icon name="Sparkles" className="w-5 h-5 text-amber-100" />
                                2026 法會日期一覽
                            </h3>
                            <button 
                                onClick={onClose}
                                className="text-amber-100 hover:text-white hover:bg-amber-700/50 p-1.5 rounded-full transition-colors"
                            >
                                <Icon name="X" className="w-6 h-6" />
                            </button>
                        </div>

                        {/* Modal Body */}
                        <div className="p-0 overflow-y-auto custom-scrollbar flex-grow bg-slate-50">
                            {isLoading ? (
                                <div className="flex flex-col items-center justify-center h-64 text-slate-500 gap-3">
                                    <Icon name="Loader" className="w-8 h-8 animate-spin text-amber-500" />
                                    <p>正在讀取法會資料...</p>
                                </div>
                            ) : data.length === 0 ? (
                                <div className="p-8 text-center text-slate-500">暫無資料</div>
                            ) : (
                                <div className="divide-y divide-slate-200">
                                    {data.map((item, index) => (
                                        <div key={index} className="bg-white p-4 hover:bg-amber-50 transition-colors flex flex-col sm:flex-row sm:items-center gap-3 sm:gap-6 border-b border-slate-100 last:border-0">
                                            {/* 日期區塊 */}
                                            <div className="flex items-center gap-2 sm:w-32 shrink-0">
                                                <div className="bg-amber-100 text-amber-800 text-xs font-bold px-2 py-1 rounded uppercase tracking-wider">
                                                    DATE
                                                </div>
                                                <span className="font-mono font-bold text-slate-700 text-lg">
                                                    {item.date}
                                                </span>
                                            </div>

                                            {/* 內容區塊 */}
                                            <div className="flex-grow">
                                                <h4 className="font-bold text-slate-800 text-base mb-1">
                                                    {item.title}
                                                </h4>
                                                <div className="flex items-center gap-1.5 text-sm text-slate-500">
                                                    <Icon name="MapPin" className="w-3.5 h-3.5 text-slate-400" />
                                                    {item.location}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            {error && (
                                <div className="bg-orange-50 p-4 text-center border-t border-orange-100">
                                    <p className="text-xs text-orange-600 flex items-center justify-center gap-1">
                                        <Icon name="Info" className="w-3 h-3" />
                                        注意：目前顯示的是內建備用資料 ({error})
                                    </p>
                                </div>
                            )}
                        </div>
                        
                        {/* Modal Footer */}
                        <div className="bg-slate-50 border-t border-slate-200 p-4 shrink-0 text-center text-xs text-slate-400 flex justify-between items-center">
                             <span>資料來源: {error ? '內建備份' : 'Embedded Data'}</span>
                             <button 
                                onClick={onClose}
                                className="bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 px-4 py-1.5 rounded shadow-sm transition-colors"
                             >
                                關閉
                             </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 月曆元件 ---
        const CalendarView = ({ onDateSelect, eventDates, dharmaDatesMap, searchTerm }) => {
            const [currentDate, setCurrentDate] = useState(new Date()); 

            // 自動跳轉月份邏輯
            useEffect(() => {
                if (!searchTerm) return;
                
                if (/^\d/.test(searchTerm)) {
                    const parts = searchTerm.split(/[\/\-\.]/);
                    let year = 2026;
                    let month = -1;

                    if (parts.length >= 1) {
                         const p1 = parseInt(parts[0], 10);
                         
                         if (parts.length === 1) {
                             if (p1 >= 1 && p1 <= 12) month = p1;
                         } else {
                             const p2 = parseInt(parts[1], 10);
                             if (p1 > 1000) {
                                 year = p1;
                                 if (p2 >= 1 && p2 <= 12) month = p2;
                             } else {
                                 if (p1 >= 1 && p1 <= 12) month = p1;
                             }
                         }
                    }

                    if (month !== -1 && year === 2026) {
                        setCurrentDate(new Date(year, month - 1, 1));
                    }
                }
            }, [searchTerm]);

            const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
            const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

            const handlePrevMonth = () => {
                setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            };

            const handleNextMonth = () => {
                setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            };

            const daysInMonth = getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth());
            const firstDay = getFirstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth());
            
            const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];

            const renderDays = () => {
                const days = [];
                for (let i = 0; i < firstDay; i++) {
                    days.push(<div key={`empty-${i}`} className="h-24 sm:h-32 bg-slate-50/50 border border-slate-100"></div>);
                }
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateKey = `${currentDate.getFullYear()}/${String(currentDate.getMonth() + 1).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
                    const hasEvent = eventDates.has(dateKey); // 志工排班
                    const dharmaInfo = dharmaDatesMap.get(dateKey); // 法會
                    const hasDharma = !!dharmaInfo;
                    
                    const dayOfWeek = (firstDay + day - 1) % 7;
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

                    // 檢查是否為當前搜尋選中的日期
                    const isSelected = searchTerm && (searchTerm === dateKey || searchTerm.replace(/^2026\//, '') === `${currentDate.getMonth() + 1}/${day}`);

                    days.push(
                        <div 
                            key={day} 
                            onClick={() => onDateSelect(dateKey)}
                            className={`h-24 sm:h-32 border border-slate-200 bg-white hover:bg-emerald-50 transition cursor-pointer p-1 sm:p-1.5 flex flex-col relative group overflow-hidden
                                ${isWeekend ? 'bg-slate-50' : ''}
                                ${isSelected ? 'ring-2 ring-emerald-500 ring-inset bg-emerald-50' : ''}
                            `}
                        >
                            <div className="flex justify-between items-start mb-0.5 shrink-0">
                                <span className={`text-sm font-semibold w-6 h-6 flex items-center justify-center rounded-full transition-colors
                                    ${isWeekend ? 'text-red-500' : 'text-slate-700'} 
                                    ${hasEvent ? 'bg-emerald-100 text-emerald-800' : ''}
                                    ${isSelected ? 'bg-emerald-600 text-white' : ''}
                                    `}
                                >
                                    {day}
                                </span>
                            </div>
                            
                            <div className="flex flex-col w-full flex-grow overflow-hidden gap-1">
                                
                                {/* 1. 排班資訊 (上排) */}
                                {hasEvent && (
                                    <div className="flex items-center gap-1 mt-0.5 px-0.5 shrink-0">
                                       <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 block shrink-0"></span>
                                       <span className="text-[11px] text-emerald-600 font-medium truncate">排班</span>
                                    </div>
                                )}

                                {/* 2. 法會資訊 (下排，樣式仿照圖片) */}
                                {hasDharma && (
                                    <div className="mt-auto sm:mt-1 bg-purple-50 rounded px-1.5 py-1 border border-purple-100/60 shadow-sm overflow-hidden min-h-[36px] flex flex-col justify-center">
                                        <div className="flex items-center gap-1 mb-0.5">
                                            <span className="w-1.5 h-1.5 rounded-full bg-purple-500 shrink-0"></span>
                                            <span className="text-[10px] leading-tight text-purple-700 font-bold truncate">
                                                {dharmaInfo.title.replace(/法會|日/g, '')}
                                            </span>
                                        </div>
                                        <div className="flex items-center gap-0.5 text-[9px] text-slate-400 pl-2.5 truncate">
                                            <Icon name="MapPin" className="w-2 h-2 shrink-0 opacity-70" />
                                            <span className="truncate">{dharmaInfo.location.split(' ')[0]}</span>
                                        </div>
                                    </div>
                                )}
                                
                            </div>
                        </div>
                    );
                }
                return days;
            };

            return (
                <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden mb-6">
                    <div className="flex items-center justify-between px-6 py-4 bg-emerald-50 border-b border-emerald-100">
                        <button onClick={handlePrevMonth} className="p-2 hover:bg-emerald-200 rounded-full transition text-emerald-800">
                            <Icon name="ChevronLeft" className="w-5 h-5" />
                        </button>
                        <h2 className="text-xl font-bold text-emerald-900">
                            {currentDate.getFullYear()} 年 {monthNames[currentDate.getMonth()]}
                        </h2>
                        <button onClick={handleNextMonth} className="p-2 hover:bg-emerald-200 rounded-full transition text-emerald-800">
                            <Icon name="ChevronRight" className="w-5 h-5" />
                        </button>
                    </div>

                    <div className="grid grid-cols-7 border-b border-slate-200 bg-slate-50 text-center py-2 text-sm font-medium text-slate-500">
                        <div className="text-red-500">日</div>
                        <div>一</div>
                        <div>二</div>
                        <div>三</div>
                        <div>四</div>
                        <div>五</div>
                        <div className="text-green-600">六</div>
                    </div>

                    <div className="grid grid-cols-7 bg-slate-100 gap-px border-b border-slate-200">
                        {renderDays()}
                    </div>
                    
                    <div className="px-4 py-2 bg-slate-50 border-t border-slate-200 flex gap-4 text-xs text-slate-500 justify-end">
                        <div className="flex items-center gap-1">
                             <span className="w-2 h-2 rounded-full bg-emerald-500"></span> 志工排班
                        </div>
                        <div className="flex items-center gap-1">
                             <span className="w-2 h-2 rounded-full bg-purple-500"></span> 法會  {/* 修改處 1: 法會日期 -> 法會 */}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 主應用程式 ---
        const App = () => {
            const [rawData, setRawData] = useState([]); 
            const [dataVersion, setDataVersion] = useState("讀取中...");
            const [searchTerm, setSearchTerm] = useState('');
            const [searchUnit, setSearchUnit] = useState('所有單位');
            const [results, setResults] = useState([]);
            const [isXlsxReady, setIsXlsxReady] = useState(false);
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const [viewMode, setViewMode] = useState('list');

            const [dharmaData, setDharmaData] = useState([]);
            const [isDharmaLoading, setIsDharmaLoading] = useState(false);
            const [dharmaError, setDharmaError] = useState(null);
            const [isDharmaModalOpen, setIsDharmaModalOpen] = useState(false);

            useEffect(() => {
                const loadExternalData = async () => {
                    try {
                        console.log("開始讀取 RAWData.json...");
                        const response = await fetch(`./RAWData.json?t=${new Date().getTime()}`);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        
                        const jsonData = await response.json();
                        console.log("成功讀取資料筆數:", jsonData.length);

                        if (Array.isArray(jsonData)) {
                            setRawData(jsonData);
                            setDataVersion("GitHub 線上資料");
                            setIsDataLoaded(true);
                        } else {
                            throw new Error("格式錯誤：檔案內容必須是 JSON 陣列");
                        }
                    } catch (error) {
                        console.error("讀取失敗:", error);
                        setDataVersion("讀取失敗");
                        alert(`讀取資料失敗，請檢查：\n1. RAWData.json 是否已上傳\n2. 錯誤訊息: ${error.message}`);
                    }
                };

                loadExternalData();
            }, []);

            useEffect(() => {
                const loadDharmaData = async () => {
                    setIsDharmaLoading(true);
                    setDharmaError(null);
                    try {
                        console.log("嘗試從外部檔案讀取 2026DharmaServiceDate.json...");
                        const response = await fetch(`./2026DharmaServiceDate.json?t=${new Date().getTime()}`);
                        if (!response.ok) throw new Error(`Status: ${response.status}`);
                        const jsonData = await response.json();
                        
                        if (Array.isArray(jsonData)) {
                            setDharmaData(jsonData);
                            console.log("成功讀取外部 2026DharmaServiceDate.json");
                        } else {
                            throw new Error("格式錯誤");
                        }
                    } catch (error) {
                        console.warn("讀取法會資料失敗，切換至內建備用資料:", error);
                        setDharmaData(EMBEDDED_DHARMA_DATA);
                        setDharmaError("無法讀取外部檔案，已顯示內建資料");
                    } finally {
                        setIsDharmaLoading(false);
                    }
                };
                loadDharmaData();
            }, []);
            
            const dharmaDatesMap = useMemo(() => {
                const map = new Map();
                dharmaData.forEach(item => {
                    map.set(item.date, item);
                });
                return map;
            }, [dharmaData]);

            useEffect(() => {
                if (window.XLSX) {
                    setIsXlsxReady(true);
                }
            }, []);

            const flattenedData = useMemo(() => {
                return rawData.flatMap(entry => {
                    const displayDate = ensureYearInString(entry.date);
                    const normDate = normalizeDate(entry.date);
                    const nameList = Array.isArray(entry.names) ? entry.names : [entry.names];
                    
                    return nameList.map(name => ({
                       id: `${displayDate}-${name}-${Math.random()}`,
                        rawDate: displayDate,
                        date: normDate,
                        type: entry.type,
                        name: name,
                        role: entry.role,
                        content: entry.content || "" 
                    })).filter(item => item.name && item.name !== "待定");
                });
            }, [rawData]);

            const availableUnits = useMemo(() => {
                const units = new Set(flattenedData.map(item => item.type));
                return ['所有單位', ...Array.from(units).sort()];
            }, [flattenedData]);

            const eventDates = useMemo(() => {
                const dates = new Set();
                const sourceData = (searchTerm || searchUnit !== '所有單位') ? results : flattenedData;
                sourceData.forEach(item => {
                    dates.add(item.date);
                });
                return dates;
            }, [results, flattenedData, searchTerm, searchUnit]); 

            const handleCalendarDateClick = (dateStr) => {
                setSearchTerm(dateStr);
                // 如果在月曆模式下點擊，可以考慮滾動到結果區，但目前保持原位即可
            };

            useEffect(() => {
                let filtered = flattenedData;
                
                if (searchUnit !== '所有單位') {
                    filtered = filtered.filter(item => item.type === searchUnit);
                }
                
                const term = searchTerm.trim().toLowerCase();
                if (term) {
                    filtered = filtered.filter(item => {
                        const nameMatch = item.name.toLowerCase().includes(term);
                        const dateMatch = item.date.includes(term) || item.rawDate.includes(term);
                        return nameMatch || dateMatch;
                    });
                } else {
                    if (searchUnit === '所有單位' && term === '') {
                        filtered = [];
                    }
                }
                
                filtered.sort((a, b) => a.date.localeCompare(b.date));
                setResults(filtered);
            }, [searchTerm, searchUnit, flattenedData]);

            // 修改處 2: 計算當前搜尋日期是否有對應的法會 (互動連動邏輯)
            const currentDharma = useMemo(() => {
                if (!searchTerm) return null;
                // 嘗試將 searchTerm 標準化為 2026/MM/DD 格式
                const normTerm = normalizeDate(searchTerm);
                // 嘗試直接比對或標準化後比對
                return dharmaDatesMap.get(searchTerm) || dharmaDatesMap.get(normTerm);
            }, [searchTerm, dharmaDatesMap]);

            const handleExportTxt = () => {
                if (results.length === 0) return;
                let content = `排班表查詢結果 - 單位:${searchUnit} | 搜尋:${searchTerm || '(無)'}\n`;
                content += `匯出時間: ${new Date().toLocaleString()}\n\n`;
                content += `日期\t\t單位\t\t姓名\t\t職務/內容\n`;
                content += `----------------------------------------------------------\n`;
                results.forEach(item => {
                    content += `${item.rawDate}\t${item.type}\t${item.name}\t${item.role} ${item.content ? `(${item.content})` : ''}\n`;
                });
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `schedule_export.txt`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const handleExportXlsx = () => {
                if (results.length === 0 || !isXlsxReady || !window.XLSX) {
                    alert("Excel 匯出功能尚未準備好，請稍候再試。");
                    return;
                }
                const dataToExport = results.map(item => ({
                    "日期": item.rawDate,
                    "單位": item.type,
                    "姓名": item.name,
                    "職務": item.role,
                    "備註/內容": item.content
                }));
                const ws = window.XLSX.utils.json_to_sheet(dataToExport);
                const wb = window.XLSX.utils.book_new();
                window.XLSX.utils.book_append_sheet(wb, ws, "查詢結果");
                window.XLSX.writeFile(wb, `schedule_export.xlsx`);
            };

            return (
                <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col">

                    <DharmaModal 
                        isOpen={isDharmaModalOpen} 
                        onClose={() => setIsDharmaModalOpen(false)} 
                        data={dharmaData}
                        isLoading={isDharmaLoading}
                        error={dharmaError}
                    />
                
                    <header className="bg-emerald-700 text-white shadow-lg shrink-0">
                        <div className="max-w-5xl mx-auto px-4 py-4">
                            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <h1 className="text-2xl font-bold flex items-center gap-2">
                                        <Icon name="Calendar" className="w-8 h-8" />
                                        志工排班查詢系統 2026
                                    </h1>
                                    
                                    <div className="flex flex-col gap-1 mt-1">
                                        <div className="flex items-center gap-3 text-sm opacity-90">
                                           <span className="font-mono bg-emerald-800 px-2 py-0.5 rounded flex items-center gap-1">
                                             <Icon name="Database" className="w-3 h-3" /> {dataVersion}
                                           </span>
                                           <span className="font-mono bg-emerald-600 px-2 py-0.5 rounded opacity-80 text-xs">
                                             {APP_VERSION}
                                           </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-5xl mx-auto px-4 py-8 flex-grow w-full">
                        <div className="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-6 flex items-start gap-3 text-sm text-blue-800">
                            <Icon name="AlertCircle" className="w-5 h-5 shrink-0 mt-0.5" />
                            <div>
                                <p><strong>資料說明：</strong></p>
                                <ul className="list-disc list-inside mt-1 space-y-1 text-blue-700">
                                    <li><strong>志工排班包含下列志工：</strong> 大愛、大佛手、聖地輪值、道場功法、大正功法、護衛隊、讀書會、攝影座談會。</li>
                                </ul>
                            </div>
                        </div>

                        <div className="bg-white rounded-xl shadow-md p-6 mb-8 border border-slate-200">
                            <div className="flex flex-col gap-4">
                                
                                <div className="flex justify-between border-b border-slate-100 pb-4">
                                    <button 
                                        onClick={() => setIsDharmaModalOpen(true)}
                                        className="group bg-amber-500 hover:bg-amber-400 text-white text-sm font-bold py-1.5 px-4 rounded-lg flex items-center gap-2 transition-all shadow-sm hover:shadow-md transform hover:-translate-y-0.5"
                                    >
                                        <Icon name="Sparkles" className="w-4 h-4 fill-current" />
                                        法會日期
                                    </button>
                                    
                                    <div className="flex bg-slate-100 p-1 rounded-lg">
                                        <button
                                            onClick={() => setViewMode('list')}
                                            className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${
                                                viewMode === 'list' ? 'bg-white text-emerald-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                                            }`}
                                        >
                                            <Icon name="List" className="w-4 h-4" />
                                            列表模式
                                        </button>
                                        <button
                                            onClick={() => setViewMode('calendar')}
                                            className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${
                                                viewMode === 'calendar' ? 'bg-white text-emerald-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                                            }`}
                                        >
                                            <Icon name="Grid" className="w-4 h-4" />
                                            月曆模式
                                        </button>
                                   </div>
                                </div>

                                <div className="flex flex-col sm:flex-row gap-4">
                                   <div className="relative min-w-[160px] flex-1 sm:flex-none">
                                      <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                        <Icon name="Filter" className="h-4 w-4 text-emerald-600" />
                                      </div>
                                      <select
                                        value={searchUnit}
                                        onChange={(e) => setSearchUnit(e.target.value)}
                                        className="block w-full pl-9 pr-3 py-3 border border-slate-300 rounded-lg leading-5 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-slate-700 font-medium transition-all shadow-sm appearance-none cursor-pointer"
                                      >
                                        {availableUnits.map(unit => (
                                          <option key={unit} value={unit}>{unit}</option>
                                        ))}
                                      </select>
                                      <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                        <svg className="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                                      </div>
                                   </div>

                                   <div className="relative group w-full flex-1">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                      <Icon name="Search" className="h-5 w-5 text-slate-400 group-focus-within:text-emerald-500 transition-colors" />
                                    </div>
                                    <input
                                      type="text"
                                      value={searchTerm}
                                      onChange={(e) => setSearchTerm(e.target.value)}
                                      placeholder="查姓名或日期 (例如: 彌勒澄明 或 2026/1/1)..."
                                      className="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all shadow-sm"
                                    />
                                  </div>
                                </div>
                            </div>
                        </div>

                        {viewMode === 'calendar' && (
                          <div className="mb-6">
                            <CalendarView 
                                onDateSelect={handleCalendarDateClick} 
                                eventDates={eventDates} 
                                dharmaDatesMap={dharmaDatesMap}
                                searchTerm={searchTerm} 
                            />
                          </div>
                        )}
                        
                        <div className="space-y-4">
                          <div className="flex items-center justify-between">
                            <h2 className="text-xl font-semibold text-slate-700 flex items-center gap-2">
                              <Icon name="FileText" className="w-5 h-5" />
                              查詢結果 {results.length > 0 && <span className="text-sm font-normal text-slate-500">({results.length} 筆資料)</span>}
                            </h2>
                            
                            {results.length > 0 && (
                              <div className="flex gap-2">
                                <button 
                                  onClick={handleExportTxt}
                                  className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md text-sm transition-colors border border-slate-300"
                                >
                                  <Icon name="FileText" className="w-4 h-4" />
                                  TXT
                                </button>
                                <button 
                                  onClick={handleExportXlsx}
                                  disabled={!isXlsxReady}
                                  title={!isXlsxReady ? "正在載入匯出元件..." : "匯出 Excel"}
                                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm transition-colors border 
                                    ${isXlsxReady ? 'bg-green-100 hover:bg-green-200 text-green-800 border-green-300 cursor-pointer' : 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'}`}
                                >
                                  <Icon name="FileSpreadsheet" className="w-4 h-4" />
                                  Excel
                                </button>
                              </div>
                            )}
                          </div>

                          {/* 修改處 3: 顯示法會資訊卡片 (當前選擇的日期若有法會) */}
                          {currentDharma && (
                            <div className="mb-2 bg-purple-50 border border-purple-200 rounded-xl p-4 flex items-start gap-4 shadow-sm animate-fade-in-down">
                                <div className="bg-purple-100 p-2.5 rounded-full shrink-0">
                                    <Icon name="Sparkles" className="w-6 h-6 text-purple-600 fill-current" />
                                </div>
                                <div className="flex-grow">
                                    <h3 className="font-bold text-purple-900 text-lg flex items-center gap-2">
                                        {currentDharma.title}
                                    </h3>
                                    <div className="flex items-center gap-2 text-purple-700 mt-1 font-medium">
                                        <Icon name="Calendar" className="w-4 h-4" />
                                        <span>{currentDharma.date}</span>
                                        <span className="text-purple-300 mx-1">|</span>
                                        <Icon name="MapPin" className="w-4 h-4" />
                                        <span>{currentDharma.location}</span>
                                    </div>
                                </div>
                            </div>
                          )}

                          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[300px]">
                            {!isDataLoaded ? (
                                <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                                  <Icon name="Loader" className="w-8 h-8 mb-4 animate-spin text-emerald-600" />
                                  <p>正在從資料庫讀取資料...</p>
                                </div>
                            ) : (searchTerm === '' && searchUnit === '所有單位' ? (
                              <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                                <Icon name="Search" className="w-12 h-12 mb-2 opacity-20" />
                                <p>請輸入查詢條件或選擇單位以開始搜尋</p>
                              </div>
                            ) : results.length === 0 ? (
                              <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                                <Icon name="Info" className="w-12 h-12 mb-2 opacity-20" />
                                <p>找不到符合的資料</p>
                              </div>
                            ) : (
                              <div className="overflow-x-auto">
                                <table className="min-w-full divide-y divide-slate-200">
                                  <thead className="bg-slate-50">
                                    <tr>
                                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">日期</th>
                                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">單位</th>
                                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">姓名</th>
                                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">職務 / 內容</th>
                                    </tr>
                                  </thead>
                                  <tbody className="bg-white divide-y divide-slate-200">
                                    {results.map((item) => (
                                      <tr key={item.id} className="hover:bg-emerald-50 transition-colors group">
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-900 font-medium">{item.rawDate}</td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                                          <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                            ${item.type.includes('大愛') ? 'bg-pink-100 text-pink-800' : 
                                              item.type.includes('大佛手') ? 'bg-blue-100 text-blue-800' : 
                                              item.type.includes('護衛隊') ? 'bg-gray-100 text-gray-800' :
                                              'bg-purple-100 text-purple-800'}`}>
                                            {item.type}
                                          </span>
                                        </td>
                                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-bold">{item.name}</td>
                                        <td className="px-6 py-4 text-sm text-slate-500">
                                          {item.role}
                                          {item.content && <span className="ml-2 text-slate-400">({item.content})</span>}
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            ))}
                          </div>
                        </div>
                    </main>

                    <footer className="bg-slate-100 border-t border-slate-200 mt-auto py-6 shrink-0">
                        <div className="max-w-5xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center text-slate-500 text-sm gap-2">
                          <p>© 2026 志工排班管理系統 | 使用 React & Tailwind CSS 建置</p>
                          <div className="flex items-center gap-2 bg-slate-200 px-3 py-1 rounded-full text-slate-600 font-medium">
                             <Icon name="Database" className="w-4 h-4" />
                             <span>資料庫總筆數: {flattenedData.length} 筆</span>
                          </div>
                        </div>
                    </footer>
                </div>
            );
        };

        // 啟動 React
        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
