<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>志工排班查詢系統 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        // 注意：這裡直接從 lucide-react 引入所有圖示可能會導致瀏覽器加載較慢
        // 但為了相容原本程式碼，我們維持原樣
        import { Search, Calendar, User, Download, FileText, FileSpreadsheet, RefreshCw, Settings, Info, Lock, Database, ExternalLink, AlertCircle, Cloud, Filter, CheckCircle, XCircle, ArrowRight, ChevronLeft, ChevronRight, Grid, List, X, Sparkles, MessageSquare, Loader, Copy, Bot } from 'lucide-react';

        // ========================================== Replace from below =====================================================
 const APP_VERSION = "App v3.2.0 (Unified Search & External Data)"; 
const DEFAULT_DATA_VERSION = "Data from RAWData.ini";

// --- 輔助函式 ---

const normalizeDate = (dateStr) => {
  if (!dateStr) return "";
  if (dateStr.match(/^\d{4}\/\d{1,2}\/\d{1,2}/)) {
    const cleanDate = dateStr.split(' ')[0];
    const parts = cleanDate.split('/');
    return `${parts[0]}/${parts[1].padStart(2, '0')}/${parts[2].padStart(2, '0')}`;
  }
  const match = dateStr.match(/(\d{1,2})\/(\d{1,2})/);
  if (match) {
    return `2026/${match[1].padStart(2, '0')}/${match[2].padStart(2, '0')}`;
  }
  return dateStr;
};

const ensureYearInString = (dateStr) => {
  if (!dateStr) return "";
  const str = String(dateStr).trim();
  if (!str.match(/^\d{4}/)) {
    return `2026/${str}`;
  }
  return str;
};

// 原始預設資料 (已清空，改由外部讀取)
const INITIAL_RAW_DATA = [];

// --- 月曆元件 ---
const CalendarView = ({ onDateSelect, eventDates }) => {
  const [currentDate, setCurrentDate] = useState(new Date()); 

  const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
  const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();

  const handlePrevMonth = () => {
    setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
  };

  const handleNextMonth = () => {
    setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
  };

  const daysInMonth = getDaysInMonth(currentDate.getFullYear(), currentDate.getMonth());
  const firstDay = getFirstDayOfMonth(currentDate.getFullYear(), currentDate.getMonth());
  
  const monthNames = ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"];

  const renderDays = () => {
    const days = [];
    for (let i = 0; i < firstDay; i++) {
      days.push(<div key={`empty-${i}`} className="h-20 sm:h-24 bg-slate-50/50 border border-slate-100"></div>);
    }
    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${currentDate.getFullYear()}/${String(currentDate.getMonth() + 1).padStart(2, '0')}/${String(day).padStart(2, '0')}`;
      const hasEvent = eventDates.has(dateKey);
      
      const dayOfWeek = (firstDay + day - 1) % 7;
      const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;

      days.push(
        <div 
          key={day} 
          onClick={() => onDateSelect(dateKey)}
          className={`h-20 sm:h-24 border border-slate-200 bg-white hover:bg-emerald-50 transition cursor-pointer p-1 sm:p-2 flex flex-col relative group
            ${isWeekend ? 'bg-slate-50' : ''}`}
        >
          <span className={`text-sm font-semibold w-6 h-6 flex items-center justify-center rounded-full 
            ${isWeekend ? 'text-red-500' : 'text-slate-700'} 
            ${hasEvent ? 'bg-emerald-100 text-emerald-800' : ''}`}
          >
            {day}
          </span>
          
          {hasEvent && (
            <div className="mt-1 flex flex-wrap gap-1 content-start">
               <span className="w-1.5 h-1.5 rounded-full bg-emerald-500 block"></span>
               <span className="text-[10px] text-emerald-600 font-medium hidden sm:inline truncate w-full">有點擊查看</span>
            </div>
          )}
        </div>
      );
    }
    return days;
  };

  return (
    <div className="bg-white rounded-xl shadow-lg border border-slate-200 overflow-hidden mb-6">
      <div className="flex items-center justify-between px-6 py-4 bg-emerald-50 border-b border-emerald-100">
        <button onClick={handlePrevMonth} className="p-2 hover:bg-emerald-200 rounded-full transition text-emerald-800">
          <ChevronLeft className="w-5 h-5" />
        </button>
        <h2 className="text-xl font-bold text-emerald-900">
          {currentDate.getFullYear()} 年 {monthNames[currentDate.getMonth()]}
        </h2>
        <button onClick={handleNextMonth} className="p-2 hover:bg-emerald-200 rounded-full transition text-emerald-800">
          <ChevronRight className="w-5 h-5" />
        </button>
      </div>

      <div className="grid grid-cols-7 border-b border-slate-200 bg-slate-50 text-center py-2 text-sm font-medium text-slate-500">
        <div className="text-red-500">日</div>
        <div>一</div>
        <div>二</div>
        <div>三</div>
        <div>四</div>
        <div>五</div>
        <div className="text-green-600">六</div>
      </div>

      <div className="grid grid-cols-7 bg-slate-100 gap-px border-b border-slate-200">
        {renderDays()}
      </div>
    </div>
  );
};

// --- 主應用程式 ---
const App = () => {
  const [rawData, setRawData] = useState(INITIAL_RAW_DATA);
  const [dataVersion, setDataVersion] = useState(DEFAULT_DATA_VERSION);
  const [searchTerm, setSearchTerm] = useState('');
  // 移除 searchType，因為現在是統一搜尋
  const [searchUnit, setSearchUnit] = useState('所有單位');
  const [results, setResults] = useState([]);
  const [isXlsxReady, setIsXlsxReady] = useState(false);
  const [isDataLoaded, setIsDataLoaded] = useState(false);
  
  // 視圖狀態
  const [viewMode, setViewMode] = useState('list');

  // 初始化：嘗試讀取 RAWData.ini
  useEffect(() => {
    const loadExternalData = async () => {
        try {
            // 嘗試讀取 RAWData.ini (請確保此檔案位於 public 資料夾或同層目錄)
            const response = await fetch('RAWData.json');
            if (!response.ok) throw new Error("File not found");
            const text = await response.text();
            
            // 嘗試解析 JSON
            const jsonData = JSON.parse(text);
            
            if (Array.isArray(jsonData)) {
                setRawData(jsonData);
                setDataVersion("外部資料 (RAWData.ini)");
            } else {
                throw new Error("Format Error: 檔案內容必須是 JSON 陣列");
            }
        } catch (error) {
            console.error("讀取 RAWData.ini 失敗:", error);
            // 錯誤處理：保持空陣列或顯示錯誤提示
            // 這裡不做動作，維持 INITIAL_RAW_DATA (空陣列)
        } finally {
            setIsDataLoaded(true);
        }
    };

    loadExternalData();
  }, []);

  // 動態載入 SheetJS (保留匯出功能)
  useEffect(() => {
    if (window.XLSX) {
      setIsXlsxReady(true);
      return;
    }
    const script = document.createElement('script');
    script.src = "https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js";
    script.onload = () => {
      setIsXlsxReady(true);
    };
    document.head.appendChild(script);
  }, []);

  const flattenedData = useMemo(() => {
    return rawData.flatMap(entry => {
      const displayDate = ensureYearInString(entry.date);
      const normDate = normalizeDate(entry.date);
      const nameList = Array.isArray(entry.names) ? entry.names : [entry.names];
      
      return nameList.map(name => ({
        id: Math.random().toString(36).substr(2, 9),
        rawDate: displayDate,
        date: normDate,
        type: entry.type,
        name: name,
        role: entry.role,
        content: entry.content || "" 
      })).filter(item => item.name && item.name !== "待定");
    });
  }, [rawData]);

  const availableUnits = useMemo(() => {
    const units = new Set(flattenedData.map(item => item.type));
    return ['所有單位', ...Array.from(units).sort()];
  }, [flattenedData]);

  const eventDates = useMemo(() => {
    const dates = new Set();
    results.forEach(item => {
        dates.add(item.date);
    });
    return dates;
  }, [results]); 

  const handleCalendarDateClick = (dateStr) => {
    // 點擊月曆日期時，直接將日期填入搜尋欄
    setSearchTerm(dateStr);
  };

  // 統一搜尋邏輯 (同時比對姓名與日期)
  useEffect(() => {
    let filtered = flattenedData;
    
    // 1. 單位篩選
    if (searchUnit !== '所有單位') {
      filtered = filtered.filter(item => item.type === searchUnit);
    }
    
    // 2. 關鍵字搜尋 (同時查姓名或日期)
    const term = searchTerm.trim().toLowerCase();
    if (term) {
      filtered = filtered.filter(item => {
        const nameMatch = item.name.toLowerCase().includes(term);
        // 日期比對：比對正規化日期 (2026/01/01) 或 原始日期 (1/1)
        const dateMatch = item.date.includes(term) || item.rawDate.includes(term);
        return nameMatch || dateMatch;
      });
    } else {
      if (searchUnit === '所有單位') {
         filtered = [];
      }
    }
    
    filtered.sort((a, b) => a.date.localeCompare(b.date));
    setResults(filtered);
  }, [searchTerm, searchUnit, flattenedData]);

  const handleExportTxt = () => {
    if (results.length === 0) return;
    let content = `排班表查詢結果 - 單位:${searchUnit} | 搜尋:${searchTerm || '(無)'}\n`;
    content += `匯出時間: ${new Date().toLocaleString()}\n\n`;
    content += `日期\t\t單位\t\t姓名\t\t職務/內容\n`;
    content += `----------------------------------------------------------\n`;
    results.forEach(item => {
      content += `${item.rawDate}\t${item.type}\t${item.name}\t${item.role} ${item.content ? `(${item.content})` : ''}\n`;
    });
    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `schedule_export.txt`;
    link.click();
    URL.revokeObjectURL(url);
  };

  const handleExportXlsx = () => {
    if (results.length === 0 || !isXlsxReady || !window.XLSX) {
      alert("Excel 匯出功能尚未準備好，請稍候再試。");
      return;
    }
    const dataToExport = results.map(item => ({
      "日期": item.rawDate,
      "單位": item.type,
      "姓名": item.name,
      "職務": item.role,
      "備註/內容": item.content
    }));
    const ws = window.XLSX.utils.json_to_sheet(dataToExport);
    const wb = window.XLSX.utils.book_new();
    window.XLSX.utils.book_append_sheet(wb, ws, "查詢結果");
    window.XLSX.writeFile(wb, `schedule_export.xlsx`);
  };

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex flex-col">
      {/* Header */}
      <header className="bg-emerald-700 text-white shadow-lg shrink-0">
        <div className="max-w-5xl mx-auto px-4 py-4">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
              <h1 className="text-2xl font-bold flex items-center gap-2">
                <Calendar className="w-8 h-8" />
                志工排班查詢系統 2026
              </h1>
              
              <div className="flex flex-col gap-1 mt-1">
                <div className="flex items-center gap-3 text-sm opacity-90">
                   <span className="font-mono bg-emerald-800 px-2 py-0.5 rounded flex items-center gap-1">
                     <Database className="w-3 h-3" /> {dataVersion}
                   </span>
                   <span className="font-mono bg-emerald-600 px-2 py-0.5 rounded opacity-80 text-xs">
                     {APP_VERSION}
                   </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-5xl mx-auto px-4 py-8 flex-grow w-full">
        {/* Notice */}
        <div className="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-6 flex items-start gap-3 text-sm text-blue-800">
           <AlertCircle className="w-5 h-5 shrink-0 mt-0.5" />
           <div>
             <p><strong>資料說明：</strong></p>
             <ul className="list-disc list-inside mt-1 space-y-1 text-blue-700">
               <li><strong>志工排班包含下列志工：</strong> 大愛、大佛手、聖地輪值、道場功法、大正功法、護衛隊、讀書會、攝影座談會。</li>
              </ul>
           </div>
        </div>

        {/* Search Controls */}
        <div className="bg-white rounded-xl shadow-md p-6 mb-8 border border-slate-200">
          <div className="flex flex-col gap-4">
            
            {/* View Mode Toggle */}
            <div className="flex justify-end border-b border-slate-100 pb-4">
               <div className="flex bg-slate-100 p-1 rounded-lg">
                  <button
                    onClick={() => setViewMode('list')}
                    className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${
                      viewMode === 'list' ? 'bg-white text-emerald-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                    }`}
                  >
                    <List className="w-4 h-4" />
                    列表模式
                  </button>
                  <button
                    onClick={() => setViewMode('calendar')}
                    className={`flex items-center gap-2 px-4 py-1.5 rounded-md text-sm font-medium transition-all ${
                      viewMode === 'calendar' ? 'bg-white text-emerald-700 shadow-sm' : 'text-slate-500 hover:text-slate-700'
                    }`}
                  >
                    <Grid className="w-4 h-4" />
                    月曆模式
                  </button>
               </div>
            </div>

            {/* Top Row: Unit Filter & Search Input */}
            <div className="flex flex-col sm:flex-row gap-4">
               <div className="relative min-w-[160px] flex-1 sm:flex-none">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <Filter className="h-4 w-4 text-emerald-600" />
                  </div>
                  <select
                    value={searchUnit}
                    onChange={(e) => setSearchUnit(e.target.value)}
                    className="block w-full pl-9 pr-3 py-3 border border-slate-300 rounded-lg leading-5 bg-slate-50 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-slate-700 font-medium transition-all shadow-sm appearance-none cursor-pointer"
                  >
                    {availableUnits.map(unit => (
                      <option key={unit} value={unit}>{unit}</option>
                    ))}
                  </select>
                  <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                    <svg className="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg>
                  </div>
               </div>

               {/* Unified Input Field */}
               <div className="relative group w-full flex-1">
                <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                  <Search className="h-5 w-5 text-slate-400 group-focus-within:text-emerald-500 transition-colors" />
                </div>
                <input
                  type="text"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  placeholder="查姓名或日期 (例如: 彌勒澄明 或 2026/1/1)..."
                  className="block w-full pl-10 pr-3 py-3 border border-slate-300 rounded-lg leading-5 bg-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 transition-all shadow-sm"
                />
              </div>
            </div>
          </div>
        </div>

        {/* Content Area */}
        {viewMode === 'calendar' && (
          <div className="mb-6">
            <CalendarView onDateSelect={handleCalendarDateClick} eventDates={eventDates} />
          </div>
        )}
        
        {/* Results Area */}
        <div className="space-y-4">
          <div className="flex items-center justify-between">
            <h2 className="text-xl font-semibold text-slate-700 flex items-center gap-2">
              <FileText className="w-5 h-5" />
              查詢結果 {results.length > 0 && <span className="text-sm font-normal text-slate-500">({results.length} 筆資料)</span>}
            </h2>
            
            {results.length > 0 && (
              <div className="flex gap-2">
                <button 
                  onClick={handleExportTxt}
                  className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-md text-sm transition-colors border border-slate-300"
                >
                  <FileText className="w-4 h-4" />
                  TXT
                </button>
                <button 
                  onClick={handleExportXlsx}
                  disabled={!isXlsxReady}
                  title={!isXlsxReady ? "正在載入匯出元件..." : "匯出 Excel"}
                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-md text-sm transition-colors border 
                    ${isXlsxReady ? 'bg-green-100 hover:bg-green-200 text-green-800 border-green-300 cursor-pointer' : 'bg-slate-100 text-slate-400 border-slate-200 cursor-not-allowed'}`}
                >
                  <FileSpreadsheet className="w-4 h-4" />
                  Excel
                </button>
              </div>
            )}
          </div>

          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden min-h-[300px]">
            {!isDataLoaded ? (
                <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                  <p>正在載入資料...</p>
                </div>
            ) : (searchTerm === '' && searchUnit === '所有單位' ? (
              <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                <Search className="w-12 h-12 mb-2 opacity-20" />
                <p>請輸入查詢條件或選擇單位以開始搜尋</p>
              </div>
            ) : results.length === 0 ? (
              <div className="flex flex-col items-center justify-center h-64 text-slate-400">
                <Info className="w-12 h-12 mb-2 opacity-20" />
                <p>找不到符合的資料</p>
              </div>
            ) : (
              <div className="overflow-x-auto">
                <table className="min-w-full divide-y divide-slate-200">
                  <thead className="bg-slate-50">
                    <tr>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">日期</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">單位</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">姓名</th>
                      <th scope="col" className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">職務 / 內容</th>
                    </tr>
                  </thead>
                  <tbody className="bg-white divide-y divide-slate-200">
                    {results.map((item) => (
                      <tr key={item.id} className="hover:bg-emerald-50 transition-colors group">
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-900 font-medium">{item.rawDate}</td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm">
                          <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                            ${item.type.includes('大愛') ? 'bg-pink-100 text-pink-800' : 
                              item.type.includes('大佛手') ? 'bg-blue-100 text-blue-800' : 
                              item.type.includes('護衛隊') ? 'bg-gray-100 text-gray-800' :
                              'bg-purple-100 text-purple-800'}`}>
                            {item.type}
                          </span>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-700 font-bold">{item.name}</td>
                        <td className="px-6 py-4 text-sm text-slate-500">
                          {item.role}
                          {item.content && <span className="ml-2 text-slate-400">({item.content})</span>}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            ))}
          </div>
        </div>
      </main>

      {/* Footer */}
      <footer className="bg-slate-100 border-t border-slate-200 mt-auto py-6 shrink-0">
        <div className="max-w-5xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center text-slate-500 text-sm gap-2">
          <p>© 2026 志工排班管理系統 | 使用 React & Tailwind CSS 建置</p>
          <div className="flex items-center gap-2 bg-slate-200 px-3 py-1 rounded-full text-slate-600 font-medium">
             <Database className="w-4 h-4" />
             <span>資料庫總筆數: {flattenedData.length} 筆</span>
          </div>
        </div>
      </footer>
    </div>
  );
};


        /* 注意：你的原始碼最後一行是 `export default App;` 
           但在單一 HTML 檔案中不需要 export，請把該行刪除，改用下方的渲染程式碼。
        */

        // ==========================================
        // ↑↑↑ 程式碼貼上結束 ↑↑↑
        // ==========================================

        // 6. 啟動 React
        const container = document.getElementById('root');
        const root = createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>